<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admissibility Physics — Live Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Source+Serif+4:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0c0e13; --bg2: #141720; --bg3: #1a1e2a;
  --border: #2a2f3e; --text: #c8cdd8; --text2: #8a90a0;
  --accent: #5b9cf5; --green: #4ade80; --yellow: #fbbf24;
  --red: #f87171; --orange: #fb923c; --purple: #a78bfa; --cyan: #22d3ee;
  --ep-P: #4ade80; --ep-Ps: #fbbf24; --ep-Cs: #fb923c; --ep-C: #8a90a0;
  --gap-closed: #4ade80; --gap-import: #5b9cf5; --gap-open: #f87171; --gap-regime: #fb923c;
  --ps-open: #f87171; --ps-qft: #a78bfa; --ps-regime: #fb923c;
}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--text);font-family:'Source Serif 4',Georgia,serif;line-height:1.5;min-height:100vh}
code,.mono{font-family:'JetBrains Mono',monospace}
.header{background:linear-gradient(135deg,#0f1218,#151a26,#0f1218);border-bottom:1px solid var(--border);padding:2rem 2rem 1.5rem}
.header h1{font-size:1.6rem;font-weight:700;letter-spacing:-0.02em;color:#fff}
.header .subtitle{color:var(--text2);font-size:0.9rem;margin-top:0.25rem}
.hero-row{display:flex;gap:1rem;margin-top:1.25rem;flex-wrap:wrap}
.hero-card{background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:0.9rem 1.2rem;min-width:130px;flex:1}
.hero-card .label{font-size:0.72rem;color:var(--text2);text-transform:uppercase;letter-spacing:0.08em;font-family:'JetBrains Mono',monospace}
.hero-card .value{font-size:1.5rem;font-weight:700;color:#fff;margin-top:0.15rem}
.hero-card .value.green{color:var(--green)}.hero-card .value.accent{color:var(--accent)}
.hero-card .value.yellow{color:var(--yellow)}.hero-card .value.red{color:var(--red)}
.tabs{display:flex;gap:0;border-bottom:1px solid var(--border);background:var(--bg2);overflow-x:auto}
.tab{padding:0.7rem 1.3rem;cursor:pointer;font-size:0.82rem;font-family:'JetBrains Mono',monospace;color:var(--text2);border-bottom:2px solid transparent;white-space:nowrap;transition:all 0.15s}
.tab:hover{color:var(--text);background:var(--bg3)}.tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.content{padding:1.5rem 2rem 3rem;max-width:1200px}.panel{display:none}.panel.active{display:block}
.section-title{font-size:1.1rem;font-weight:700;color:#fff;margin:1.5rem 0 0.75rem;padding-bottom:0.4rem;border-bottom:1px solid var(--border)}
.section-title:first-child{margin-top:0}
.card-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:0.75rem}
.ep-bar-container{margin:1rem 0 0.5rem}
.ep-bar{display:flex;height:28px;border-radius:4px;overflow:hidden;border:1px solid var(--border)}
.ep-bar .segment{display:flex;align-items:center;justify-content:center;font-family:'JetBrains Mono',monospace;font-size:0.72rem;font-weight:600;color:#000;transition:width 0.5s}
.ep-legend{display:flex;gap:1.2rem;margin-top:0.5rem;flex-wrap:wrap}
.ep-legend-item{display:flex;align-items:center;gap:0.35rem;font-size:0.78rem;font-family:'JetBrains Mono',monospace;color:var(--text2)}
.ep-legend-item .dot{width:10px;height:10px;border-radius:2px}
table{width:100%;border-collapse:collapse;font-size:0.85rem;margin:0.5rem 0}
th{text-align:left;padding:0.55rem 0.7rem;font-family:'JetBrains Mono',monospace;font-size:0.72rem;text-transform:uppercase;letter-spacing:0.06em;color:var(--text2);border-bottom:1px solid var(--border)}
td{padding:0.5rem 0.7rem;border-bottom:1px solid #1e2230}
tr:hover td{background:var(--bg3)}
.tag{display:inline-block;padding:0.15rem 0.45rem;border-radius:3px;font-family:'JetBrains Mono',monospace;font-size:0.7rem;font-weight:600}
.tag-P{background:rgba(74,222,128,0.15);color:var(--ep-P)}
.tag-Ps{background:rgba(251,191,36,0.15);color:var(--ep-Ps)}
.tag-Cs{background:rgba(251,146,60,0.15);color:var(--ep-Cs)}
.tag-C{background:rgba(138,144,160,0.15);color:var(--ep-C)}
.tag-closed{background:rgba(74,222,128,0.12);color:var(--gap-closed)}
.tag-import{background:rgba(91,156,245,0.12);color:var(--gap-import)}
.tag-open{background:rgba(248,113,113,0.12);color:var(--gap-open)}
.tag-regime{background:rgba(251,146,60,0.12);color:var(--gap-regime)}
.thm-card{background:var(--bg2);border:1px solid var(--border);border-radius:6px;padding:0.75rem 0.9rem;border-left:3px solid var(--border)}
.thm-card.ep-P{border-left-color:var(--ep-P)}.thm-card.ep-Ps{border-left-color:var(--ep-Ps)}
.thm-card.ep-Cs{border-left-color:var(--ep-Cs)}.thm-card.ep-C{border-left-color:var(--ep-C)}
.thm-card .tid{font-family:'JetBrains Mono',monospace;font-weight:700;font-size:0.85rem;color:#fff}
.thm-card .kr{font-size:0.8rem;color:var(--text2);margin-top:0.25rem}
.thm-card .meta{margin-top:0.4rem;display:flex;gap:0.4rem;flex-wrap:wrap}
.tier-grid{margin:1rem 0}
.tier-row{display:grid;grid-template-columns:180px 1fr;gap:0.75rem;margin-bottom:0.6rem;align-items:start}
.tier-label{font-family:'JetBrains Mono',monospace;font-size:0.78rem;color:var(--text2);padding-top:0.3rem}
.tier-thms{display:flex;flex-wrap:wrap;gap:0.35rem}
.tier-chip{padding:0.25rem 0.55rem;border-radius:4px;font-family:'JetBrains Mono',monospace;font-size:0.72rem;font-weight:600;cursor:default;border:1px solid transparent}
.tier-chip.ep-P{background:rgba(74,222,128,0.12);color:var(--ep-P);border-color:rgba(74,222,128,0.25)}
.tier-chip.ep-Ps{background:rgba(251,191,36,0.1);color:var(--ep-Ps);border-color:rgba(251,191,36,0.25)}
.tier-chip.ep-Cs{background:rgba(251,146,60,0.1);color:var(--ep-Cs);border-color:rgba(251,146,60,0.25)}
.tier-chip.ep-C{background:rgba(138,144,160,0.1);color:var(--ep-C);border-color:rgba(138,144,160,0.25)}
.tier-chip.clickable{cursor:pointer}.tier-chip.clickable:hover{opacity:0.8}
svg text{font-family:'JetBrains Mono',monospace}
.import-item{background:var(--bg2);border:1px solid var(--border);border-radius:6px;padding:0.7rem 0.9rem;margin-bottom:0.5rem}
.import-item .name{font-weight:700;color:var(--accent);font-size:0.9rem}
.import-item .detail{color:var(--text2);font-size:0.82rem;margin-top:0.2rem}
.import-item .used-by{font-family:'JetBrains Mono',monospace;font-size:0.72rem;color:var(--green);margin-top:0.3rem}
.ps-reason-bar{display:flex;gap:0.5rem;margin:0.75rem 0;flex-wrap:wrap}
.ps-reason-chip{padding:0.4rem 0.8rem;border-radius:4px;font-family:'JetBrains Mono',monospace;font-size:0.78rem;font-weight:600}
.loading{text-align:center;padding:3rem;color:var(--text2);font-size:1.1rem}
.loading .spinner{display:inline-block;width:24px;height:24px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;margin-right:0.5rem;vertical-align:middle}
@keyframes spin{to{transform:rotate(360deg)}}
.error-msg{background:rgba(248,113,113,0.1);border:1px solid rgba(248,113,113,0.3);border-radius:8px;padding:1.5rem;color:var(--red);text-align:center;margin:2rem}
@media(max-width:700px){.content{padding:1rem}.hero-row{flex-direction:column}.tier-row{grid-template-columns:1fr}}
/* Constants panel */
.const-card{background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:0;margin-bottom:0.65rem;cursor:pointer;transition:border-color 0.15s,background 0.15s;overflow:hidden}
.const-card:hover{border-color:var(--accent);background:var(--bg3)}
.const-header{display:flex;justify-content:space-between;align-items:baseline;padding:0.75rem 1rem 0.3rem}
.const-name{font-weight:700;color:#fff;font-size:0.95rem}
.const-value{font-family:'JetBrains Mono',monospace;font-size:0.88rem;color:var(--accent);font-weight:600}
.const-row{display:flex;gap:0;padding:0 1rem 0.5rem;flex-wrap:wrap}
.const-cell{flex:1;min-width:100px;padding:0.2rem 0.5rem 0.2rem 0}
.const-label{display:block;font-family:'JetBrains Mono',monospace;font-size:0.65rem;text-transform:uppercase;letter-spacing:0.06em;color:var(--text2)}
.const-data{font-size:0.82rem;color:var(--text)}
.const-chevron{font-family:'JetBrains Mono',monospace;font-size:0.72rem;color:var(--text2);padding:0.35rem 1rem 0.55rem;border-top:1px solid var(--border);background:rgba(0,0,0,0.15);text-align:center}
.chain-wrapper{border-top:1px solid var(--border);background:rgba(0,0,0,0.2);padding:1rem 1.2rem}
.chain-container{position:relative}
.chain-axioms{display:flex;gap:0.4rem;margin-bottom:0.75rem;flex-wrap:wrap}
.axiom-badge{font-family:'JetBrains Mono',monospace;font-size:0.72rem;font-weight:700;padding:0.2rem 0.55rem;border-radius:3px;background:rgba(91,156,245,0.15);color:var(--accent);border:1px solid rgba(91,156,245,0.3)}
.chain-step{display:flex;gap:0.6rem;margin-bottom:0;min-height:44px;align-items:flex-start}
.chain-connector{display:flex;flex-direction:column;align-items:center;width:18px;flex-shrink:0;position:relative}
.chain-line{width:2px;height:100%;background:var(--border);position:absolute;top:0;left:50%;transform:translateX(-50%)}
.chain-dot{width:10px;height:10px;border-radius:50%;position:relative;z-index:1;flex-shrink:0;margin-top:4px}
.chain-step-final .chain-line{height:50%}
.chain-content{padding-bottom:0.5rem;flex:1;min-width:0}
.chain-explain{margin-top:0.6rem;padding:0.65rem 0.8rem;background:rgba(91,156,245,0.06);border-left:3px solid var(--accent);border-radius:0 4px 4px 0;font-size:0.82rem;color:var(--text);line-height:1.55}
</style>
</head>
<body>
<div class="header">
  <h1 id="title">Admissibility Physics Engine — Loading...</h1>
  <div class="subtitle" id="subtitle">Fetching dashboard data...</div>
  <div class="hero-row" id="heroRow"></div>
</div>
<div class="tabs" id="tabBar"></div>
<div class="content" id="content">
  <div class="loading" id="loadingMsg"><span class="spinner"></span> Loading dashboard data...</div>
</div>
<script>
const JSON_URL='dashboard_data.json';
let DATA=null;

async function loadData(){
  try{
    const resp=await fetch(JSON_URL);
    if(!resp.ok) throw new Error('HTTP '+resp.status+': '+resp.statusText);
    DATA=await resp.json();
    buildDashboard();
  }catch(err){
    document.getElementById('loadingMsg').innerHTML=
      '<div class="error-msg"><strong>Could not load dashboard_data.json</strong><br>'+
      '<span style="font-size:0.85rem;color:var(--text2)">'+err.message+'<br><br>'+
      'Run: <code>python3 Admissibility_Physics_Engine_V3_5.py --export-dashboard</code><br>'+
      'to generate this file, then commit it to the repo.</span></div>';
  }
}

function epClass(ep){
  if(ep==='P') return 'ep-P';
  if(ep==='P_structural') return 'ep-Ps';
  if(ep==='C_structural') return 'ep-Cs';
  return 'ep-C';
}
function epTag(ep){
  const cls=ep==='P'?'tag-P':ep==='P_structural'?'tag-Ps':ep==='C_structural'?'tag-Cs':'tag-C';
  const label=ep==='P_structural'?'P_str':ep==='C_structural'?'C_str':ep;
  return '<span class="tag '+cls+'">'+label+'</span>';
}
function gapTag(gap){
  const cls=gap==='closed'?'tag-closed':gap==='import'?'tag-import':gap==='open_physics'?'tag-open':'tag-regime';
  return '<span class="tag '+cls+'">'+gap+'</span>';
}
function psReasonTag(reason){
  if(reason==='open_physics') return '<span class="tag tag-open">open physics</span>';
  if(reason==='qft_import') return '<span class="tag tag-import">QFT import</span>';
  if(reason==='regime_dependent') return '<span class="tag tag-regime">regime</span>';
  if(reason==='rep_selection') return '<span class="tag" style="background:rgba(34,211,238,0.12);color:var(--cyan)">rep selection</span>';
  return '<span class="tag tag-C">other</span>';
}

function buildDashboard(){
  document.getElementById('loadingMsg').remove();
  const ec=DATA.epistemic_counts;
  const total=DATA.total_theorems;

  document.getElementById('title').textContent='Admissibility Physics Engine v'+DATA.version;
  document.getElementById('subtitle').textContent='Live dashboard \u00b7 Generated '+DATA.date+' \u00b7 '+total+' theorems';

  const pPct=Math.round((ec.P||0)/total*100);
  const openCount=Object.values(DATA.p_structural_reasons).filter(r=>r==='open_physics').length;
  const auditFixed=DATA.audit_checks.filter(a=>a.status==='FIXED').length;

  document.getElementById('heroRow').innerHTML=
    '<div class="hero-card"><div class="label">Theorems</div><div class="value green">'+DATA.passed+'/'+total+'</div></div>'+
    '<div class="hero-card"><div class="label">[P] Proven</div><div class="value accent">'+(ec.P||0)+' ('+pPct+'%)</div></div>'+
    '<div class="hero-card"><div class="label">Open Physics</div><div class="value yellow">'+openCount+'</div></div>'+
    '<div class="hero-card"><div class="label">Dep Cycles</div><div class="value '+(DATA.dependency_check.cycles===0?'green':'red')+'">'+DATA.dependency_check.cycles+'</div></div>'+
    '<div class="hero-card"><div class="label">Audit Fixed</div><div class="value accent">'+auditFixed+'/'+DATA.audit_checks.length+'</div></div>';

  var tabs=[
    {id:'status',label:'Status'},{id:'epistemic',label:'Epistemic Map'},
    {id:'accuracy',label:'Predictions'},{id:'constants',label:'Constants'},
    {id:'theorems',label:'Theorems'},
    {id:'imports',label:'Math Imports'},{id:'audit',label:'Audit'}
  ];
  var tabBar=document.getElementById('tabBar');
  var content=document.getElementById('content');
  tabs.forEach(function(t,i){
    var div=document.createElement('div');
    div.className='tab'+(i===0?' active':'');
    div.textContent=t.label;
    div.onclick=function(){
      document.querySelectorAll('.tab').forEach(function(e){e.classList.remove('active')});
      document.querySelectorAll('.panel').forEach(function(e){e.classList.remove('active')});
      div.classList.add('active');
      document.getElementById('panel-'+t.id).classList.add('active');
    };
    tabBar.appendChild(div);
  });
  tabs.forEach(function(t,i){
    var panel=document.createElement('div');
    panel.id='panel-'+t.id;
    panel.className='panel'+(i===0?' active':'');
    content.appendChild(panel);
  });
  buildStatusPanel();
  buildEpistemicPanel();
  buildAccuracyPanel();
  buildTheoremsPanel();
  buildConstantsPanel();
  buildImportsPanel();
  buildAuditPanel();
}

function buildStatusPanel(){
  var el=document.getElementById('panel-status');
  var ec=DATA.epistemic_counts, total=DATA.total_theorems;
  var segments=[
    {label:'P',count:ec.P||0,color:'var(--ep-P)'},
    {label:'P_str',count:ec.P_structural||0,color:'var(--ep-Ps)'},
    {label:'C_str',count:ec.C_structural||0,color:'var(--ep-Cs)'},
    {label:'C',count:ec.C||0,color:'var(--ep-C)'}
  ];
  var h='<div class="section-title">Epistemic Distribution</div><div class="ep-bar-container"><div class="ep-bar">';
  segments.forEach(function(s){
    var pct=(s.count/total*100).toFixed(1);
    if(s.count>0) h+='<div class="segment" style="width:'+pct+'%;background:'+s.color+'">'+s.count+'</div>';
  });
  h+='</div><div class="ep-legend">';
  segments.forEach(function(s){
    h+='<div class="ep-legend-item"><span class="dot" style="background:'+s.color+'"></span>['+s.label+'] '+s.count+' ('+(s.count/total*100).toFixed(0)+'%)</div>';
  });
  h+='</div></div>';

  var psReasons=DATA.p_structural_reasons;
  var rCounts={};
  Object.values(psReasons).forEach(function(r){rCounts[r]=(rCounts[r]||0)+1});
  var reasonColors={open_physics:'var(--ps-open)',qft_import:'var(--ps-qft)',regime_dependent:'var(--ps-regime)',rep_selection:'var(--cyan)'};
  var reasonLabels={open_physics:'Open Physics',qft_import:'QFT Import',regime_dependent:'Regime-Dependent',rep_selection:'Rep Selection'};
  h+='<div class="section-title">P_structural Breakdown (Why Not [P]?)</div><div class="ps-reason-bar">';
  Object.entries(rCounts).forEach(function(e){
    var r=e[0],c=e[1];
    h+='<div class="ps-reason-chip" style="background:'+reasonColors[r]+'22;color:'+reasonColors[r]+';border:1px solid '+reasonColors[r]+'44">'+reasonLabels[r]+': '+c+'</div>';
  });
  h+='</div><table><tr><th>Theorem</th><th>Reason</th><th>What\'s Needed</th></tr>';
  Object.entries(psReasons).forEach(function(e){
    var tid=e[0],reason=e[1];
    var needs=reason==='open_physics'?'UV completion / Majorana-Dirac':reason==='qft_import'?'Physics \u03b2-coefficients (not pure math)':reason==='rep_selection'?'A5 \u2192 fundamental reps (structural, not logical)':'Regime assumptions R12.1, R12.2';
    h+='<tr><td class="mono">'+tid+'</td><td>'+psReasonTag(reason)+'</td><td style="color:var(--text2);font-size:0.82rem">'+needs+'</td></tr>';
  });
  h+='</table>';

  h+='<div class="section-title">Tier Summary</div><table><tr><th>Tier</th><th>Name</th><th>Pass</th><th>Epistemic Mix</th></tr>';
  Object.entries(DATA.tier_stats).sort(function(a,b){return +a[0]- +b[0]}).forEach(function(e){
    var tier=e[0],info=e[1];
    var tierThms=Object.entries(DATA.theorems).filter(function(x){return x[1].tier===+tier});
    var epMix={};
    tierThms.forEach(function(x){epMix[x[1].epistemic]=(epMix[x[1].epistemic]||0)+1});
    var mixStr=Object.entries(epMix).map(function(x){return epTag(x[0])+' \u00d7'+x[1]}).join(' ');
    h+='<tr><td class="mono">'+tier+'</td><td>'+info.name+'</td><td class="mono" style="color:var(--green)">'+info.passed+'/'+info.total+'</td><td>'+mixStr+'</td></tr>';
  });
  h+='</table>';

  h+='<div class="section-title">Sector Verdicts</div><div style="display:flex;gap:0.75rem;flex-wrap:wrap">';
  Object.entries(DATA.sector_verdicts).forEach(function(e){
    var sec=e[0],ok=e[1];
    var color=ok?'var(--green)':'var(--red)';
    var icon=ok?'\u2713':'\u2717';
    h+='<div class="hero-card" style="border-color:'+color+'40"><div class="label">'+sec+'</div><div class="value" style="color:'+color+'">'+icon+'</div></div>';
  });
  h+='</div>';
  el.innerHTML=h;
}

function buildEpistemicPanel(){
  var el=document.getElementById('panel-epistemic');
  var tierNames={};
  Object.entries(DATA.tier_stats).forEach(function(e){tierNames[e[0]]=e[1].name});
  var h='<div class="section-title">Tier \u00d7 Epistemic Grid</div><div class="tier-grid">';
  for(var tier=0;tier<=5;tier++){
    var thms=Object.entries(DATA.theorems).filter(function(x){return x[1].tier===tier}).sort(function(a,b){
      var order={P:0,P_structural:1,C_structural:2,C:3};
      return(order[a[1].epistemic]||9)-(order[b[1].epistemic]||9);
    });
    if(thms.length===0) continue;
    h+='<div class="tier-row"><div class="tier-label">T'+tier+': '+(tierNames[tier]||'')+'</div><div class="tier-thms">';
    thms.forEach(function(x){
      var tid=x[0],t=x[1];
      h+='<div class="tier-chip '+epClass(t.epistemic)+'" title="'+t.key_result.substring(0,60)+'">'+tid+'</div>';
    });
    h+='</div></div>';
  }
  h+='</div>';

  h+='<div class="section-title">Gap Classification by Tier</div>';
  h+='<table><tr><th>Tier</th><th style="color:var(--gap-closed)">Closed</th><th style="color:var(--gap-import)">Import</th><th style="color:var(--gap-open)">Open Physics</th></tr>';
  for(var tier=0;tier<=5;tier++){
    var thms=Object.entries(DATA.theorems).filter(function(x){return x[1].tier===tier});
    if(thms.length===0) continue;
    var gaps={closed:0,'import':0,open_physics:0};
    thms.forEach(function(x){gaps[x[1].gap_type]=(gaps[x[1].gap_type]||0)+1});
    h+='<tr><td class="mono">T'+tier+': '+(tierNames[tier]||'')+'</td>';
    h+='<td class="mono" style="color:var(--gap-closed)">'+(gaps.closed||'\u2014')+'</td>';
    h+='<td class="mono" style="color:var(--gap-import)">'+(gaps['import']||'\u2014')+'</td>';
    h+='<td class="mono" style="color:var(--gap-open)">'+(gaps.open_physics||'\u2014')+'</td></tr>';
  }
  h+='</table>';

  // Stacked bar SVG
  var W=600,H=200,padL=120,padR=20,padT=20,padB=30;
  var chartW=W-padL-padR, chartH=H-padT-padB;
  var colors={P:'#4ade80',P_structural:'#fbbf24',C_structural:'#fb923c',C:'#8a90a0'};
  h+='<div class="section-title">Epistemic Composition by Tier</div>';
  h+='<svg viewBox="0 0 '+W+' '+H+'" style="width:100%;max-width:'+W+'px">';
  for(var tier=0;tier<=5;tier++){
    var thms=Object.entries(DATA.theorems).filter(function(x){return x[1].tier===tier});
    if(thms.length===0) continue;
    var y=padT+tier*(chartH/6)+(chartH/6-20)/2;
    var epC={};
    thms.forEach(function(x){epC[x[1].epistemic]=(epC[x[1].epistemic]||0)+1});
    h+='<text x="'+(padL-8)+'" y="'+(y+14)+'" text-anchor="end" fill="#8a90a0" font-size="10">T'+tier+'</text>';
    var xOff=padL;
    ['P','P_structural','C_structural','C'].forEach(function(ep){
      var count=epC[ep]||0;
      if(count===0) return;
      var w=count/DATA.total_theorems*chartW*2.5;
      h+='<rect x="'+xOff+'" y="'+y+'" width="'+w+'" height="20" rx="2" fill="'+colors[ep]+'" opacity="0.85"/>';
      if(w>16) h+='<text x="'+(xOff+w/2)+'" y="'+(y+14)+'" text-anchor="middle" fill="#000" font-size="10" font-weight="600">'+count+'</text>';
      xOff+=w;
    });
  }
  h+='</svg>';
  el.innerHTML=h;
}

function buildAccuracyPanel(){
  var el=document.getElementById('panel-accuracy');
  var h='<div class="section-title">Predictions vs Experiment</div>';
  h+='<table><tr><th>Quantity</th><th>Predicted</th><th>Observed</th><th>Error</th><th>Source</th><th>Status</th></tr>';
  DATA.predictions.forEach(function(p){
    var errColor=p.error_pct===0?'var(--green)':p.error_pct<1?'var(--yellow)':'var(--orange)';
    var statusColor=p.status==='exact'?'var(--green)':p.status==='derived'?'var(--accent)':'var(--yellow)';
    h+='<tr><td style="font-weight:600">'+p.quantity+'</td><td class="mono">'+p.predicted+'</td>';
    h+='<td class="mono" style="color:var(--text2)">'+p.observed+'</td>';
    h+='<td class="mono" style="color:'+errColor+'">'+(p.error_pct===0?'exact':p.error_pct.toFixed(2)+'%')+'</td>';
    h+='<td class="mono">'+p.theorem+'</td><td style="color:'+statusColor+'">'+p.status+'</td></tr>';
  });
  h+='</table>';

  // Error bar chart
  var preds=DATA.predictions.filter(function(p){return p.error_pct>0}).sort(function(a,b){return a.error_pct-b.error_pct});
  if(preds.length>0){
    h+='<div class="section-title">Error Distribution</div>';
    var W=500,H=40+preds.length*32,padL=140,padR=60;
    var maxErr=Math.max.apply(null,preds.map(function(p){return p.error_pct}));
    h+='<svg viewBox="0 0 '+W+' '+H+'" style="width:100%;max-width:'+W+'px">';
    preds.forEach(function(p,i){
      var y=15+i*32;
      var w=(p.error_pct/maxErr)*(W-padL-padR);
      var color=p.error_pct<1?'#fbbf24':'#fb923c';
      h+='<text x="'+(padL-8)+'" y="'+(y+14)+'" text-anchor="end" fill="#8a90a0" font-size="10">'+p.quantity+'</text>';
      h+='<rect x="'+padL+'" y="'+y+'" width="'+w+'" height="20" rx="2" fill="'+color+'" opacity="0.8"/>';
      h+='<text x="'+(padL+w+6)+'" y="'+(y+14)+'" fill="'+color+'" font-size="10" font-weight="600">'+p.error_pct.toFixed(2)+'%</text>';
    });
    h+='</svg>';
  }
  el.innerHTML=h;
}

function buildTheoremsPanel(){
  var el=document.getElementById('panel-theorems');
  var h='<div class="section-title">All Theorems</div>';
  h+='<div style="display:flex;gap:0.5rem;margin-bottom:1rem;flex-wrap:wrap">';
  h+='<div class="tier-chip ep-P clickable" onclick="filterThms(\'all\')">All</div>';
  for(var t=0;t<=5;t++){
    h+='<div class="tier-chip ep-Ps clickable" onclick="filterThms('+t+')">T'+t+'</div>';
  }
  h+='<div class="tier-chip ep-Cs clickable" onclick="filterThms(\'ps\')">P_structural</div>';
  h+='</div><div id="thmGrid" class="card-grid"></div>';
  el.innerHTML=h;
  filterThms('all');
}

function filterThms(filter){
  var grid=document.getElementById('thmGrid');
  var thms=Object.entries(DATA.theorems);
  if(filter==='ps') thms=thms.filter(function(x){return x[1].epistemic==='P_structural'});
  else if(filter!=='all') thms=thms.filter(function(x){return x[1].tier===filter});
  thms.sort(function(a,b){return a[1].tier-b[1].tier});
  grid.innerHTML=thms.map(function(x){
    var tid=x[0],t=x[1];
    var imports=t.imported_theorems?t.imported_theorems.map(function(i){return '<span class="tag tag-import">'+i.substring(0,35)+'</span>'}).join(' '):'';
    var psR=t.ps_reason?psReasonTag(t.ps_reason):'';
    return '<div class="thm-card '+epClass(t.epistemic)+'">'+
      '<div class="tid">'+tid+' <span style="font-weight:400;font-size:0.72rem;color:var(--text2)">T'+t.tier+'</span></div>'+
      '<div class="kr">'+t.key_result.substring(0,90)+'</div>'+
      '<div class="meta">'+epTag(t.epistemic)+' '+gapTag(t.gap_type)+' '+psR+'</div>'+
      (imports?'<div style="margin-top:0.3rem">'+imports+'</div>':'')+
      '</div>';
  }).join('');
}

function buildConstantsPanel(){
  var el=document.getElementById('panel-constants');
  var thms=DATA.theorems;

  // Build the constants catalog from predictions + extras
  var constants=[
    {id:'sin2tw',name:'sin²θ_W',value:'3/13 ≈ 0.2308',observed:'0.23122',error:'0.19%',
     source:'T_sin2theta',chain:['T_sin2theta','T24','T23','T22','T19','T21','T20','T3','T2','T1'],
     axioms:['A1','A2','A3'],status:'derived',
     explain:'Weinberg angle from capacity competition fixed-point. The ratio of SU(2) to U(1) coupling is determined by the unique stable fixed-point of the capacity RG flow.'},
    {id:'gauge',name:'Gauge Group',value:'SU(3)×SU(2)×U(1)',observed:'SU(3)×SU(2)×U(1)',error:'exact',
     source:'T_gauge',chain:['T_gauge','T5','T4','T3','T2','T1'],
     axioms:['A1','A2','A3'],status:'exact',
     explain:'Capacity-optimal gauge group. SU(3)×SU(2)×U(1) uniquely minimizes enforcement cost at dim = 12, the smallest budget supporting chiral anomaly cancellation.'},
    {id:'ngen',name:'N_gen (generations)',value:'3',observed:'3',error:'exact',
     source:'T4F',chain:['T4F','T4E','T7'],
     axioms:['A1','A2'],status:'exact',
     explain:'Three generations from capacity saturation. E(3) = 6 ≤ 8 = C_EW but E(4) = 10 > 8. Pure integer arithmetic from the capacity budget.'},
    {id:'dim',name:'Spacetime dim d',value:'4',observed:'4',error:'exact',
     source:'T8',chain:['T8','T_gauge','T5','T4'],
     axioms:['A1','A2','A3','A5'],status:'exact',
     explain:'d = 4 from capacity partition. Pigeonhole: d ≤ 3 has no chiral fermions, d ≥ 5 exceeds capacity budget. Only d = 4 admits gauge + matter + gravity.'},
    {id:'higgs',name:'Higgs exists',value:'Yes (massive scalar)',observed:'Yes (125 GeV)',error:'exact',
     source:'T_Higgs',chain:['T_Higgs','T_particle','T_M','L_ε*'],
     axioms:['A1','A3','A4'],status:'exact',
     explain:'EW vacuum must break symmetry (V(Φ) has Φ = 0 unstable). Broken vacuum has positive curvature → massive scalar excitation necessarily exists.'},
    {id:'dm',name:'Dark matter exists',value:'Yes (geometric)',observed:'Yes (Ω_DM ≈ 0.26)',error:'—',
     source:'T12',chain:['T12','T_gauge','T0'],
     axioms:['A1','A5'],status:'proven',
     explain:'C_ext > 0 (external enforcement capacity must exist). C_ext is gauge-singlet by construction. Gauge-singlet committed capacity = dark matter. Not a particle — a geometric correlation.'},
    {id:'lambda',name:'Λ > 0',value:'Yes (residual)',observed:'Yes (Λ ≈ 10⁻¹²²)',error:'—',
     source:'T11',chain:['T11','T9_grav','T4F'],
     axioms:['A1','A4'],status:'structural',
     explain:'Cosmological constant = global capacity residual after all enforcement commitments. Near-saturation (3 generations use 75%) explains why Λ is small but nonzero.'},
    {id:'fb',name:'f_b (baryon fraction)',value:'0.200',observed:'0.157',error:'27.4%',
     source:'T12E',chain:['T12E','T12','T11'],
     axioms:['A1','A5'],status:'structural',
     explain:'f_b = 1/(1+α_eff) where α_eff = C_dark/C_visible. C_visible = 12 (from T_gauge). α_eff = 4.0 is structural estimate. Gap: C_total not independently derived.'},
    {id:'fields',name:'Field content',value:'{Q_L, L_L, u_R, d_R, e_R}',observed:'{Q_L, L_L, u_R, d_R, e_R}',error:'exact',
     source:'T_field',chain:['T_field','T_channels','T_gauge','T4'],
     axioms:['A1','A2','A5'],status:'structural',
     explain:'Anomaly cancellation Diophantine system has unique solution: Y_Q = 1/6, Y_u = 2/3, Y_d = −1/3, Y_L = −1/2, Y_e = −1. Gap: fundamental reps from A5 minimality.'},
    {id:'hyper',name:'Hypercharges (Y_Q)',value:'1/6',observed:'1/6',error:'exact',
     source:'T_field',chain:['T_field','T_channels','T_gauge','T4'],
     axioms:['A1','A2','A5'],status:'structural',
     explain:'Unique solution of 4 anomaly equations: SU(3)²×U(1), SU(2)²×U(1), gravitational, and U(1)³ cubic. Exact rational arithmetic — no fitting.'},
    {id:'channels',name:'EW channels',value:'4',observed:'—',error:'—',
     source:'T_channels',chain:['T_channels','T_gauge','T5'],
     axioms:['A1','A2'],status:'derived',
     explain:'Exhaustive anomaly scan over all (mixer, bookkeeper) splits below 4 — all fail. At (3,1): solution exists. channels_EW = 4 is the minimum admissible count.'},
    {id:'axiom_w',name:'Axiom witnesses',value:'Δ = 4 (superadditivity)',observed:'—',error:'—',
     source:'T0',chain:['T0'],
     axioms:['A1','A2','A4'],status:'witnessed',
     explain:'Finite-world executable certificates. T0.2b\': superadditivity Δ = 4 witnessed at ({a},{b}) on Γ1. T0.4\': record-lock by BFS certificate. Countermodels verify axiom independence.'}
  ];

  // Status colors
  function statusColor(s){
    if(s==='exact'||s==='derived'||s==='proven') return 'var(--green)';
    if(s==='structural'||s==='witnessed') return 'var(--yellow)';
    return 'var(--text2)';
  }
  function statusTag(s){
    var cls = (s==='exact'||s==='derived'||s==='proven')?'tag-P':
              (s==='structural'||s==='witnessed')?'tag-Ps':'tag-C';
    return '<span class="tag '+cls+'">'+s+'</span>';
  }
  function epTag(ep){
    if(ep==='P') return '<span class="tag tag-P">P</span>';
    if(ep==='P_structural') return '<span class="tag tag-Ps">P_str</span>';
    if(ep==='C_structural') return '<span class="tag tag-Cs">C_str</span>';
    return '<span class="tag tag-C">'+ep+'</span>';
  }

  // Build derivation chain HTML for a constant
  function buildChain(c){
    var h='<div class="chain-container">';
    // Axiom badges at root
    h+='<div class="chain-axioms">';
    c.axioms.forEach(function(a){
      h+='<span class="axiom-badge">'+a+'</span>';
    });
    h+='</div>';
    // Chain steps (reverse: axioms → result)
    var steps=c.chain.slice().reverse();
    steps.forEach(function(tid,i){
      var t=thms[tid];
      var ep=t?t.epistemic:'axiom';
      var kr=t?t.key_result:'';
      var isLast=(i===steps.length-1);
      h+='<div class="chain-step'+(isLast?' chain-step-final':'')+'">';
      h+='<div class="chain-connector"><div class="chain-line"></div><div class="chain-dot" style="background:'+
        (ep==='P'?'var(--green)':ep==='P_structural'?'var(--yellow)':'var(--text2)')+'"></div></div>';
      h+='<div class="chain-content">';
      h+='<span class="mono" style="color:#fff;font-weight:600;font-size:0.82rem">'+tid+'</span> ';
      if(t) h+=epTag(ep);
      if(kr) h+='<div style="color:var(--text2);font-size:0.78rem;margin-top:0.15rem">'+kr+'</div>';
      h+='</div></div>';
    });
    // Explanation
    h+='<div class="chain-explain">'+c.explain+'</div>';
    h+='</div>';
    return h;
  }

  // Render
  var h='<div class="section-title">Derived Constants & Physical Descriptors</div>';
  h+='<p style="color:var(--text2);font-size:0.85rem;margin-bottom:1rem">Click any constant to trace its derivation chain back to axioms.</p>';

  constants.forEach(function(c,idx){
    var errColor=c.error==='exact'?'var(--green)':c.error==='—'?'var(--text2)':
                 parseFloat(c.error)<1?'var(--yellow)':'var(--orange)';
    h+='<div class="const-card" onclick="toggleChain(\'chain-'+idx+'\')">';
    h+='<div class="const-header">';
    h+='<div class="const-name">'+c.name+'</div>';
    h+='<div class="const-value">'+c.value+'</div>';
    h+='</div>';
    h+='<div class="const-row">';
    h+='<div class="const-cell"><span class="const-label">Observed</span><span class="const-data">'+c.observed+'</span></div>';
    h+='<div class="const-cell"><span class="const-label">Error</span><span class="const-data" style="color:'+errColor+'">'+c.error+'</span></div>';
    h+='<div class="const-cell"><span class="const-label">Source</span><span class="const-data mono" style="color:var(--accent)">'+c.source+'</span></div>';
    h+='<div class="const-cell"><span class="const-label">Status</span>'+statusTag(c.status)+'</div>';
    h+='<div class="const-cell"><span class="const-label">Chain</span><span class="const-data mono">'+c.chain.length+' steps</span></div>';
    h+='</div>';
    h+='<div class="const-chevron">▾ derivation chain</div>';
    h+='<div class="chain-wrapper" id="chain-'+idx+'" style="display:none">'+buildChain(c)+'</div>';
    h+='</div>';
  });

  el.innerHTML=h;
}

function toggleChain(id){
  var el=document.getElementById(id);
  if(!el) return;
  var isOpen=el.style.display!=='none';
  el.style.display=isOpen?'none':'block';
  // Toggle chevron text
  var parent=el.parentElement;
  var chev=parent.querySelector('.const-chevron');
  if(chev) chev.innerHTML=isOpen?'▾ derivation chain':'▴ hide chain';
}

function buildImportsPanel(){
  var el=document.getElementById('panel-imports');
  var imports=DATA.math_imports;
  var count=Object.keys(imports).length;
  var h='<div class="section-title">'+count+' Mathematical Theorems Imported</div>';
  h+='<p style="color:var(--text2);margin-bottom:1rem;font-size:0.88rem">Each is a proven result from the mathematical literature. The framework derives physical consequences; the math is not conjectural.</p>';
  Object.entries(imports).sort(function(a,b){return b[1].used_by.length-a[1].used_by.length}).forEach(function(e){
    var name=e[0],info=e[1];
    var detail=typeof info.details==='string'?info.details:JSON.stringify(info.details);
    h+='<div class="import-item"><div class="name">'+name+'</div>';
    h+='<div class="detail">'+detail+'</div>';
    h+='<div class="used-by">Used by: '+info.used_by.join(', ')+'</div></div>';
  });
  el.innerHTML=h;
}

function buildAuditPanel(){
  var el=document.getElementById('panel-audit');
  var checks=DATA.audit_checks;
  var fixed=checks.filter(function(a){return a.status==='FIXED'}).length;
  var active=checks.filter(function(a){return a.status==='ACTIVE'}).length;
  var h='<div class="section-title">Audit Checks ('+fixed+' fixed, '+active+' active)</div>';
  h+='<table><tr><th>ID</th><th>Check</th><th>Status</th><th>Severity</th></tr>';
  checks.forEach(function(a){
    var sColor=a.status==='FIXED'?'var(--green)':'var(--yellow)';
    var vColor=a.severity==='critical'?'var(--red)':a.severity==='high'?'var(--orange)':a.severity==='medium'?'var(--yellow)':'var(--text2)';
    h+='<tr><td class="mono">'+a.id+'</td><td>'+a.check+'</td>';
    h+='<td class="mono" style="color:'+sColor+'">'+a.status+'</td>';
    h+='<td class="mono" style="color:'+vColor+'">'+a.severity+'</td></tr>';
  });
  h+='</table>';
  h+='<div class="section-title">Dependency Validation</div>';
  var dc=DATA.dependency_check;
  h+='<div style="display:flex;gap:1rem">';
  h+='<div class="hero-card"><div class="label">DAG Valid</div><div class="value '+(dc.valid?'green':'red')+'">'+(dc.valid?'\u2713':'\u2717')+'</div></div>';
  h+='<div class="hero-card"><div class="label">Cycles</div><div class="value '+(dc.cycles===0?'green':'red')+'">'+dc.cycles+'</div></div>';
  h+='</div>';
  if(dc.issues&&dc.issues.length>0){
    h+='<div style="margin-top:0.5rem;color:var(--red);font-size:0.85rem">';
    dc.issues.forEach(function(i){h+='<div>\u26a0 '+i+'</div>'});
    h+='</div>';
  }
  el.innerHTML=h;
}

window.filterThms=filterThms;
loadData();
</script>
</body>
</html>
